var eujsconfig_fresh = {
  "eujs1":{
    "hover": "ALBANIA",//info of the popup
    "upColor": "#d5d5d5",//default color
    "overColor": "#ECFFB3",//highlight color
    "downColor": "#cae9af",//clicking color
    "active": false//true/false to activate/deactivate
  },
  "eujs2":{
    "hover": "ANDORRA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs3":{
    "hover": "AUSTRIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs4":{
    "hover": "BELARUS",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs5":{
    "hover": "BELGIUM",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs6":{
    "hover": "BOSNIA AND HERZEGOVINA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs7":{
    "hover": "BULGARIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs8":{
    "hover": "CROATIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs9":{
    "hover": "CYPRUS",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs10":{
    "hover": "CZECH REPUBLIC",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs11":{
    "hover": "DENMARK",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs12":{
    "hover": "ESTONIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs13":{
    "hover": "FINLAND",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs14":{
    "hover": "FRANCE",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs15":{
    "hover": "GERMANY",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs16":{
    "hover": "GREECE",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs17":{
    "hover": "HUNGARY",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs18":{
    "hover": "ICELAND",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs19":{
    "hover": "IRELAND",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs20":{
    "hover": "ITALY",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs21":{
    "hover": "KOSOVO",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs22":{
    "hover": "LATVIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs23":{
    "hover": "LIECHTENSTEIN",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs24":{
    "hover": "LITHUANIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs25":{
    "hover": "LUXEMBOURG",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs26":{
    "hover": "MACEDONIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs27":{
    "hover": "MALTA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs28":{
    "hover": "MOLDOVA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs29":{
    "hover": "MONACO",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs30":{
    "hover": "MONTENEGRO",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs31":{
    "hover": "NETHERLANDS",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs32":{
    "hover": "NORWAY",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs33":{
    "hover": "POLAND",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs34":{
    "hover": "PORTUGAL",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs35":{
    "hover": "ROMANIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs36":{
    "hover": "RUSSIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs37":{
    "hover": "SAN MARINO",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs38":{
    "hover": "SERBIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs39":{
    "hover": "SLOVAKIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs40":{
    "hover": "SLOVENIA",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs41":{
    "hover": "SPAIN",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs42":{
    "hover": "SWEDEN",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs43":{
    "hover": "SWITZERLAND",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs44":{
    "hover": "UKRAINE",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs45":{
    "hover": "UNITED KINGDOM",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "eujs46":{
    "hover": "VATICAN CITY",
    "upColor": "#d5d5d5", "overColor": "#ECFFB3", "downColor": "#cae9af",
    "active": false
  },
  "general":{
    "borderColor": "#9CA8B6",
    "visibleNames": "#adadad"
  }
};

function copyToClipboard() {
  var copyText = window.location.host + "/euromap/" + $('#measurechooser').dropdown('get value');
  navigator.clipboard.writeText(copyText);
}

function addDays(date, days) {
  var result = new Date(date);
  result.setDate(result.getDate() + days);
  return result;
}

function formatDate(d)
{
            var month = d.getMonth()+1;
            var day = d.getDate();

            var date = d.getFullYear() + '-' +
                (month<10 ? '0' : '') + month + '-' +
                (day<10 ? '0' : '') + day;
            return date;
}

function readloadDate()
{
                var measuretype = $('#measurechooser').dropdown('get value');
                var seldate = document.getElementById("dateselect").value;
                loadMapData(measuretype,seldate);
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

$( document ).ready(function() {

          var dataMeasuresTypes = $.ajax({
          url: "/measuremeterdata/measuretypes/",
          dataType: "json",
          async: false
          }).responseText;

          var jsonMeasuresTypes = JSON.parse(dataMeasuresTypes);

          measuretypes = []

          $.each(jsonMeasuresTypes, function(id, line) {
                 measuretypes.push({
                    name: '<font size="5em">'+line['name']+'</font>',
                    value: line['pk']
                  });
          });

          $('#measurechooser')
              .dropdown({
                values:measuretypes
              })
            ;

            $('#dateselect').change(function() {
                           readloadDate();
            });

           $("#measurechooser").change(function() {
               readloadDate();
            });

          $("#btnPlusDays").click(function(){
                var measuretype = $('#measurechooser').dropdown('get value');

                var seldate = document.getElementById("dateselect").value;

                nextdate = addDays(seldate, 3);

                nextdate_f = formatDate(nextdate);

                document.getElementById("dateselect").value = nextdate_f;
                loadMapData(measuretype,nextdate_f);
          });

          $("#btnMinusDays").click(function(){
                var measuretype = $('#measurechooser').dropdown('get value');

                var seldate = document.getElementById("dateselect").value;

                nextdate = addDays(seldate, -3);

                nextdate_f = formatDate(nextdate);

                document.getElementById("dateselect").value = nextdate_f;
                loadMapData(measuretype,nextdate_f);
          });

          $("#btnPlay").click(async function(){
                var measuretype = $('#measurechooser').dropdown('get value');

                date = new Date(2020,2,5);
                enddate_x = new Date();
                enddate = addDays(enddate_x, 10);

                while (date < enddate)
                {
                        date_f = formatDate(date);
                        loadMapData(measuretype,date_f);
                        await sleep(100);
                        date = addDays(date, 2);
                }
          });

          $("#btnCopyLink").click(async function(){
                copyToClipboard();
          });

             var d = new Date();

            today = formatDate(d);
            document.getElementById("dateselect").value = today;

            $('#param').hide();
            if ($('#param').text() != '')
            {
                $('#measurechooser').dropdown('set selected',$('#param').text());
                loadMapData($('#param').text(),today);
            }
            else
            {
                $('#measurechooser').dropdown('set selected',26);
                loadMapData(26,today);
            }
});

var eujsconfig ={};

function loadMapData(measuretype,filterdate) {

          var dataMeasuresType = $.ajax({
          url: "/measuremeterdata/measuretypes/?pk="+measuretype,
          dataType: "json",
          async: false
          }).responseText;
          var jsonMeasuresType = JSON.parse(dataMeasuresType);

            document.getElementById('chosen_options').innerHTML = jsonMeasuresType[0]['name'] + ' // ' + filterdate;
            document.getElementById('legend').innerHTML = '<a class="ui red circular massive label">&nbsp;<font size=4em color="#000000">'+jsonMeasuresType[0]['tooltip_nonpartial']+'</div></font></a> <a class="ui yellow circular massive label">&nbsp;<font size=4em color="#000000">'+jsonMeasuresType[0]['tooltip_partial']+'</div></font></a>  <a class="ui white circular massive label"><font color="#000000" size=4em>no regulation</font></a>'

            jQuery.each(eujsconfig_fresh, function(i, val) {
              var ctry_val = {};
              eujsconfig[i] = '';
              jQuery.each(val, function(i_key, val_key) {
                        ctry_val[i_key] = val_key;
                     });
                eujsconfig[i] = ctry_val;
            });
/*----------------------------------------------------------------------------------*/

          var data = $.ajax({
          url: "/measuremeterdata/measures/?type="+measuretype.toString()+"&start="+filterdate.replace('-', '\-')+"&end="+filterdate.replace('-', '\-'),
          dataType: "json",
          async: false
          }).responseText;
          var jsonData = JSON.parse(data);

           /* +"&level=1,2" */

          var fullcolor="#ebb5ab";
          var fullcolorhover ="#e5573a";

          var partcolor="#f0e9aa";
          var partcolorhover="#f5da3c";

        var i;
            for (i = 0; i < 47; i++) {
            json_i=i+1;
            record_id='eujs'+json_i;
            countrydata = $.grep(jsonData, function( n, i ) {
                return n.country.mapcode_europe===record_id;
                });
            if (countrydata.length > 0)
            {
                   if (countrydata[0]['country']['mapcode_europe'] != null)
                    {
                      if (countrydata[0]['start'] != null)
                      {
                        var start_date_str = countrydata[0]['start']
                      }
                      else
                      {
                        var start_date_str = 'undefined'
                      }

                      if (countrydata[0]['end'] != null)
                      {
                        var end_date_str = countrydata[0]['end']
                      }
                      else
                      {
                        var end_date_str = 'undefined'
                      }

                      var color_norm = ''
                      var color_hover= ''

                      if (countrydata[0]['level'] == 1)
                      {
                         color_norm = partcolor
                         color_hover= partcolorhover
                      }
                      else if (countrydata[0]['level'] == 2)
                      {
                         color_norm = fullcolor
                         color_hover= fullcolorhover
                      }
                      else if (countrydata[0]['level'] == 0)
                      {
                         color_norm = "#FFFFFF"
                         color_hover= "#f1f1f1"
                      }

                      var tooltip = '<div style="margin-left: 5;margin-top: 5;margin-bottom: 5;margin-right: 5;width: 500"><font size="4em">'
                      tooltip += "<p><b>"+countrydata[0]['country']['name']+"</b></p>";
                      if (countrydata[0]['level'] > 0)
                      {
                        tooltip += "<p>"+ start_date_str + " - " + end_date_str + " </p>";
                      }
                      tooltip += "<hr>";
                      tooltip += countrydata[0]['comment'].toString();
                      tooltip += '</font></div>';

                        $("#"+countrydata[0]['country']['mapcode_europe']).removeAttr("style");
                        eujsconfig[countrydata[0]['country']['mapcode_europe']]['hover'] = tooltip;
                        /*eujsconfig[line['country']['mapcode_europe']]['url'] = 'XXXXX';
                        eujsconfig[line['country']['mapcode_europe']]['target'] = 'XXXXX';*/
                        eujsconfig[countrydata[0]['country']['mapcode_europe']]['upColor'] = color_norm;
                        eujsconfig[countrydata[0]['country']['mapcode_europe']]['overColor'] = color_hover;
                        /*eujsconfig[line['country']['mapcode_europe']]['downColor'] = partcolor;*/
                        eujsconfig[countrydata[0]['country']['mapcode_europe']]['active'] = true;
                        $("#"+countrydata[0]['country']['mapcode_europe']).attr("fill",color_norm);
                        euaddEvent(countrydata[0]['country']['mapcode_europe']);
                        }
                      }

            else
            {
                  /*Remove attributes, reset to normal*/
                 $("#"+record_id).attr("fill","#d5d5d5");
                 $("#"+record_id).attr("cursor",'default');
                 $("#"+record_id).removeAttr("style");
                 $("#"+record_id).off();
                 $("#"+record_id.replace('eujs','eujsvn')).off();
                 $("#"+record_id.replace('eujs','eujsvn')).attr("cursor",'default');

            }
        }

}
