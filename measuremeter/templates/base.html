{% load static i18n %}
{# Load the tag library #}
{% load bootstrap4 %}

{# Load CSS and JavaScript #}
{% bootstrap_css %}
{% bootstrap_javascript jquery='full' %}
<html>
  <head>
    <title>Covid measures by country</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

    <script type="text/javascript">
      google.charts.load("current", {packages:["timeline"]});
      google.charts.setOnLoadCallback(drawChart);

      function convertMiliseconds(miliseconds, format) {
        var days, hours, minutes, seconds, total_hours, total_minutes, total_seconds;

        total_seconds = parseInt(Math.floor(miliseconds / 1000));
        total_minutes = parseInt(Math.floor(total_seconds / 60));
        total_hours = parseInt(Math.floor(total_minutes / 60));
        days = parseInt(Math.floor(total_hours / 24));

        seconds = parseInt(total_seconds % 60);
        minutes = parseInt(total_minutes % 60);
        hours = parseInt(total_hours % 24);

        switch(format) {
        case 's':
          return total_seconds;
        case 'm':
          return total_minutes;
        case 'h':
          return total_hours;
        case 'd':
          return days;
        default:
          return { d: days, h: hours, m: minutes, s: seconds };
        }
      };


      $( document ).ready(function() {
          $("#btnSubmit").click(function(){
            var countries = ""
            $.each($("input[name='country']:checked"), function(){
                countries = countries + $(this).val() +",";
            });

            var types = ""
            $.each($("input[name='type']:checked"), function(){
                types = types + $(this).val() +",";
            });

            drawChart(countries, types);
          });



          var dataCountries = $.ajax({
          url: window.location.href + "measuremeterdata/countries/",
          dataType: "json",
          async: false
          }).responseText;

          var jsonCountries = JSON.parse(dataCountries);

          var optionsCountries='';
          optionsCountries += '<div class="form-check"><input type="checkbox" class="form-check-input" name="checkbox-all" id="checkbox-all-country" value="all"  />';
          optionsCountries += '<label class="form-check-label" for="checkbox-all">All</label></div>';

          $.each(jsonCountries, function(id, line) {
               optionsCountries += '<div class="form-check form-check-inline"><input type="checkbox" class="form-check-input" name="country" id="checkbox-' + id + '" value="' + line['pk'] + '"  />';
               optionsCountries += '<label class="form-check-label" for="checkbox-' + id + '">' + line['name'] + '</label></div>&nbsp;';
          });
          $('#countries').append(optionsCountries);

          var dataMeasuresTypes = $.ajax({
          url: window.location.href + "measuremeterdata/measuretypes/",
          dataType: "json",
          async: false
          }).responseText;

          var jsonMeasuresTypes = JSON.parse(dataMeasuresTypes);

          var optionsMeasuresTypes='';
          //optionsMeasuresTypes += '<div class="form-check"><input type="checkbox" class="form-check-input" name="checkbox-all" id="checkbox-all" value="all" />';
          //optionsMeasuresTypes += '<label class="form-check-label" for="checkbox-all">All</label></div>';

          var category = -1;

          $.each(jsonMeasuresTypes, function(id, line) {
              if (line['category']['pk'] != category)
              {
                category = line['category']['pk'];
                optionsMeasuresTypes += '<b><div class="form-check"><input type="checkbox" class="form-check-input" name="category" id="category" value="' + category + '" />';
                optionsMeasuresTypes += '<label class="form-check-label" for="checkbox-' + category + '">' + line['category']['name'] + '</label></div></b>';
              }
               optionsMeasuresTypes += '<div class="form-check form-check-inline"><input type="checkbox" class="form-check-input" name="type" id="' + category + '" value="' + line['pk'] + '"  />';
               optionsMeasuresTypes += '<label class="form-check-label" for="checkbox-' + id + '">' + line['name'] + '</label></div>&nbsp;';
          });
          $('#measurestypes').append(optionsMeasuresTypes);

          $("#checkbox-all-country").click(function() {
              if($(this).is(":checked"))
              {
                  $.each($("input[name='country']"), function(){
                      $(this).prop("checked", true);
                  });
              }
              else
              {
                  $.each($("input[name='country']"), function(){
                      $(this).prop("checked", false);
                  });
              }
          });

           $.each($("input[name='category']"), function(){
                $(this).click(function() {
                  if($(this).is(":checked"))
                  {
                    $.each($("input[id="+$(this).val()+"]"), function(){
                        $(this).prop("checked", true);
                    });
                  }
                  else
                  {
                    $.each($("input[id="+$(this).val()+"]"), function(){
                        $(this).prop("checked", false);
                    });
                  }
                });
            });

      });


      function drawChart(countries, measuretypes) {

         if (countries == undefined)
         {
           countries="";
         }
         if (measuretypes == undefined)
         {
           measuretypes="";
         }
         console.log(countries + " " + measuretypes);
          var data = $.ajax({
          url: window.location.href + "measuremeterdata/measures/?country_in="+countries+"&type_in="+measuretypes,
          dataType: "json",
          async: false
          }).responseText;
          var jsonData = JSON.parse(data);

        var containerCountry = document.getElementById('datachartCountry');
        var chartCountry = new google.visualization.Timeline(containerCountry);
        var dataTableCountry = new google.visualization.DataTable();

        dataTableCountry.addColumn({ type: 'string', id: 'Country' });
        dataTableCountry.addColumn({ type: 'string', id: 'Measure' });
        dataTableCountry.addColumn({ type: 'string', role:'tooltip'});
        dataTableCountry.addColumn({ type: 'string', role: 'style' });
        dataTableCountry.addColumn({ type: 'date', id: 'Start' });
        dataTableCountry.addColumn({ type: 'date', id: 'End' });

        var ColorClosed = ["#90d192", '#91e3e0', '#eba9e3', '#b4b9ed', '#e6c4a1', '#e6a1a4', '#a8e6d6'];
        var ColorPartial = ["#b7e8b9", '#bce6e4', '#f2d3ee', '#cfd1e8', '#ebd9c7', '#e6bec0', '#c7ebe2'];
        var color_count = 0;
        var old_measure = "";

        $.each(jsonData, function(id, line) {
          var type = line['type']['name'].toString();

          if (line['start'] != null)
          {
            var start_str = line['start'].split("-")
            var start_date = new Date(start_str[0], start_str[1]-1, start_str[2])
          }
          else
          {
            var start_date = new Date(2020, 1, 14)
          }

          if (line['end'] != null)
          {
            var end_str = line['end'].split("-")
            var end_date = new Date(end_str[0], end_str[1]-1, end_str[2])
          }
          else
          {
            var end_date = new Date(2020, 5, 31)
            type = type + "*";
          }

          //Set up tooltip
          days = convertMiliseconds(end_date - start_date,'d')+1;
          var tooltip = '<div style="margin-left: 30;margin-top: 30;width: 300">'
          tooltip += "<p><b>"+type+"</b></p>";
          tooltip += "<p>"+ line['start'] + " - " + line['end'] + " // Duration: " + days + " days</p>";
          tooltip += "<hr>";
          tooltip += line['comment'].toString();
          tooltip += '</div>';

          if ((old_measure.replace('*','')) !== (type.replace('*','')))
          {
              console.log("uneven");
              if (color_count < ColorClosed.length)
              {
                color_count += 1;
              }
              else
              {
                color_count = 0;
               }
           }
           else
           {
              console.log("even");
           }

          if (line['partial'] == true)
          {
            color = ColorPartial[color_count];
          }
          else
          {
            color = ColorClosed[color_count];
          }

          if (line['none'] == true)
          {
            color='#FFFFFF';
          }

           old_measure = type;

          var source = "Source: " + line['sources'].toString()

          dataTableCountry.addRows([[line['country']['name'].toString(),type,tooltip,color, start_date,end_date]])
});
        chartCountry.draw(dataTableCountry);

         console.log(countries + " " + measuretypes);
          var dataMeasure = $.ajax({
          url: window.location.href + "measuremeterdata/measuresbymeasure/?country_in="+countries+"&type_in="+measuretypes,
          dataType: "json",
          async: false
          }).responseText;
          var jsonDataMeasure = JSON.parse(dataMeasure);

        var containerMeasure = document.getElementById('datachartMeasure');
        var chartMeasure = new google.visualization.Timeline(containerMeasure);
        var dataTableMeasure = new google.visualization.DataTable();

        dataTableMeasure.addColumn({ type: 'string', id: 'Country' });
        dataTableMeasure.addColumn({ type: 'string', id: 'Measure' });
        dataTableMeasure.addColumn({ type: 'string', role:'tooltip'});
        dataTableMeasure.addColumn({ type: 'string', role: 'style' });
        dataTableMeasure.addColumn({ type: 'date', id: 'Start' });
        dataTableMeasure.addColumn({ type: 'date', id: 'End' });

        var ColorClosed = ["#90d192", '#91e3e0', '#eba9e3', '#b4b9ed', '#e6c4a1', '#e6a1a4', '#a8e6d6'];
        var ColorPartial = ["#b7e8b9", '#bce6e4', '#f2d3ee', '#cfd1e8', '#ebd9c7', '#e6bec0', '#c7ebe2'];
        var color_count = 0;
        var old_country = "";

        $.each(jsonDataMeasure, function(id, line) {
          var type = line['type']['name'].toString();
          country = line['country']['name'].toString();

          if (line['start'] != null)
          {
            var start_str = line['start'].split("-")
            var start_date = new Date(start_str[0], start_str[1]-1, start_str[2])
          }
          else
          {
            var start_date = new Date(2020, 1, 14)
          }


          if (line['end'] != null)
          {
            var end_str = line['end'].split("-")
            var end_date = new Date(end_str[0], end_str[1]-1, end_str[2])
          }
          else
          {
            var end_date = new Date(2020, 5, 31)
            country = country + "*";
          }

          if ((old_country.replace('*','')) !== (country.replace('*','')))
          {
              console.log("uneven");
              if (color_count < ColorClosed.length)
              {
                color_count += 1;
              }
              else
              {
                color_count = 0;
               }
           }
           else
           {
              console.log("even");
           }

          if (line['partial'] == true)
          {
            color = ColorPartial[color_count];
          }
          else
          {
            color = ColorClosed[color_count];
          }

          if (line['none'] == true)
          {
            color='#FFFFFF';
          }

           old_country = country;

          //Set up tooltip
          days = convertMiliseconds(end_date - start_date,'d')+1;
          var tooltip = '<div style="margin-left: 30;margin-top: 30;width: 300">'
          tooltip += "<p><b>"+type+"</b></p>";
          tooltip += "<p>"+ line['start'] + " - " + line['end'] + " // Duration: " + days + " days</p>";
          tooltip += "<hr>";
          tooltip += line['comment'].toString();
          tooltip += '</div>';

          var source = "Source: " + line['sources'].toString()

          dataTableMeasure.addRows([[type,country,tooltip,color,start_date,end_date]]);


});
          var options = {
            timeline: { avoidOverlappingGridLines: false }
          };

        chartMeasure.draw(dataTableMeasure, options);

      }
    </script>
  </head>
  <body>
      <div style="margin-left: 30;margin-top: 30;">

      <h1>Covid measures by country</h1>

        <div class="border border-dark" style="padding-left: 10;padding-top: 10;padding-bottom: 10;margin-bottom: 10;">
          <font size="1.5rem">
            Contact: d.berger@dontsniff.co.uk // Twitter: <a href="https://twitter.com/BergerWthur">@BergerWthur</a>// <a href="/measuremeterdata/">REST Endpoints</a> (Filter measures with country_in and type_in) // <a href="https://github.com/balzamas/covidmeasure/">Project on GitHub</a><br>
          This is still <b>PROTOTYPING</b>! Please contact me to contribute (gathering data).
          </font>
        </div>
        <div class="border border-dark" style="padding-left: 10;padding-top: 10;padding-bottom: 10;margin-bottom: 10;">
            <b>Countries:</b>
          <div id="countries"></div>
        </div>
        <div class="border border-dark" style="padding-left: 10;padding-top: 10;padding-bottom: 10;margin-bottom: 10;">
          <b>Measures:</b>
          <div id="measurestypes"></div>
        </div>
      <p><input id = "btnSubmit" class="btn btn-primary" type="submit" value="Reload"/></p>
        <b>By country</b>
          * = end of measure undefined<br>
          Dark: Full closure // Light: Partial closure/with restrictions // White: Revoked/Never introduced

          <div id="datachartCountry" style="height: 900px;"></div>
<hr>
        <b>By measure</b>
          * = end of measure undefined<br>
          Dark: Full closure // Light: Partial closure/with restrictions // White: Revoked/Never introduced
          <div id="datachartMeasure" style="height: 900px;"></div>
    </div>
  </body>
</html>




